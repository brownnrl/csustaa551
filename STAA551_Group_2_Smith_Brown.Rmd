---
title: "R Notebook"
output: pdf_document
author: "Nelson Brown and Bryce Smith"
header-includes:
- \usepackage{dcolumn}
- \usepackage{float}
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
---
```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(dplyr)
library(car)
library(ggplot2)
library(grid)
library(gridExtra)
library(ggthemes)
library(lubridate)
library(GGally)
library(scales)
library(stargazer) # Used for latex tables to summarize the data and models
```

# Introduction

This case study focuses on creating a linear model 

```{r, echo=FALSE, results='hide'}

# Read the Data
df <- read.csv('Seattle.csv', strip.white = TRUE, stringsAsFactors = FALSE)
# Clean the Data
df$date <- ymd(substr(df$date,1,nchar(df$date) - 7)) # Convert string to date object
df$was_renovated <- as.factor(with(df, 
     ifelse(yr_renovated > 0, 
            1, 
            0
          )
 ))
df$has_basement <- as.factor(with(df, 
     ifelse(sqft_basement > 0, 
            1, 
            0
          )
 ))
```


# Summary Statistics and Graphics

## Quantitative Values

```{r, echo=FALSE, results='hide'}

# Define our quantitative values of interest
df.quant <- df %>% select(price,
                          sqft_living,
                          sqft_lot,
                          bedrooms,
                          bathrooms,
                          view,
                          grade,
                          sqft_above,
                          yr_built)
```

```{r, echo=FALSE, results='asis'}

# Print head of initial dataframe
stargazer(head(df.quant), 
          rownames=FALSE, 
          summary=FALSE, 
          header=FALSE, 
          title="First Four Rows for Quantitative Values on Seattlle Housing Dataframe")
```

```{r, echo=FALSE, results='asis'}

# Summarize initial dataframe
stargazer(df.quant,
          header=FALSE,
          omit.summary.stat=c('N'),
          title="Summary Statistics for Values on Seattle Housing Dataframe")
```

```{r, echo=FALSE, results='asis'}

cor.df.quant <- cor(df.quant)

#Correlation Matrix
#invisible(stargazer(cor.df.quant,
#                    header=FALSE,
#                    title="Correlation of Quantiative Values"))
```




```{r, echo=FALSE, out.height="800px"}

# Quantitative Data Pairs
ggpairs(df.quant, progress=FALSE) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


## Discrete and Categorical Values

```{r, echo=FALSE}

# Discrete and Categorical Values Section
plot_price_by_cat <- function(df, cat_var, cat_var_name) {
  ggplot(df, aes(x=cat_var, y=price, fill=cat_var)) +
    scale_colour_solarized("red") +
    geom_violin(aes(color=cat_var)) +
    geom_boxplot(width=0.1) +
    xlab(cat_var_name) +
    ylab("Price") +
    scale_y_continuous(labels = scales::dollar_format(scale = 1)) +
    theme(legend.position="none")
}

q <- plot_price_by_cat(df, as.factor(df$view), "View")
r <- plot_price_by_cat(df, as.factor(df$grade), "Grade")
t <- plot_price_by_cat(df, as.factor(df$waterfront), "Waterfront")
w <- plot_price_by_cat(df, as.factor(df$floors), "Floors")
x <- plot_price_by_cat(df, as.factor(df$condition), "Condition")
y <- plot_price_by_cat(df, as.factor(df$has_basement), "Basement")

grid.arrange(grobs=list(q, r, t, 
                        w, x, y),
             ncol=3,
             top="Price by Categorical Variable") 
```

\newpage
\blandscape

```{r,echo=FALSE, results='asis'}
lm.price.1 <- lm(formula = price ~ sqft_living, 
            data = df)
lm.price.4 <- lm(formula = price ~ sqft_living + grade + view + waterfront, 
            data = df)
lm.price.5 <- lm(formula = price ~ sqft_living + grade + view + waterfront + yr_built, 
            data = df)
lm.price.6 <- lm(formula = price ~ sqft_living + grade + view + waterfront + yr_built + sqft_living*grade, 
            data = df)
lm.price.7 <- lm(formula = log(price) ~ log(sqft_living) + grade + view + waterfront + yr_built + log(sqft_living)*grade, 
            data = df)
lm.price.8 <- lm(formula = log(price) ~ log(sqft_living) + grade + view + yr_built, 
            data = df)
stargazer(lm.price.1, 
          lm.price.5,
          lm.price.6, 
          lm.price.7, 
          lm.price.8, 
          header=FALSE,
          align=T,
          label="ModelComparison",
          title="Model comparison showing iteratively adding predictors with strong supporting evidence")
```

\elandscape
\newpage

```{r, include=FALSE}

# Top-down model building using ANOVA analysis between full and reduced model.

sci.notation <- function(value) {
  formatC(value, format = "e", digits = 2) 
}

lm.nearfull <- lm(price ~ 
                    bedrooms + 
                    bathrooms + 
                    sqft_living + 
                    sqft_lot + 
                    floors + 
                    waterfront + 
                    view + 
                    condition + 
                    grade + 
                    sqft_above + 
                    yr_built , data=df)
anova.1 <- anova(lm.nearfull, lm.price.5)
anova.1.p.value <-formatC(anova.1$`Pr(>F)`[2], format = "e", digits = 2) 
lm.reduced <- lm(price ~ bedrooms + 
                   bathrooms + 
                   sqft_living + 
                   waterfront + 
                   view + 
                   grade + 
                   yr_built, data=df)
anova.2 <- anova(lm.nearfull, lm.reduced)
anova.2.p.value <-formatC(anova.2$`Pr(>F)`[2], format = "e", digits = 2) 
# collect adjusted R^2
nearfull.r.adjusted <- summary(lm.nearfull)
reduced.r.adjusted <-round(summary(lm.nearfull)$adj.r.squared,3)
lm5.r.adjusted <-round(summary(lm.price.5)$adj.r.squared,3)

```

We wanted to ensure that our model doesn't disagree with an alternative analysis built from a full model in that we did not miss any potential predictors that may add to our model's explained variation while offering strong evidence that they linearly associated with the predictor.  To accomplish this, we first compared a model with nearly every predictor with the exception of those predictors that could be eliminated due to their intrinsic nature or prior inspection. For instance, the id field or date of transaction was not considered in the full model.  An ANOVA was conducted between these models with an F-test statistic value of `r round(anova.1$F[2], 3)` and associated p-value `r anova.1.p.value` indicated that their may be some predictors which may be linearly associated with the response variable.

We then removed the predictors from the nearly full model by examining those with the weakest p-value evidence, and ended up with a reduced model which discarded `floors`, `sqft_above`, and `sqft_lot`.  Comparing the adjusted $R^2$ value of this reduced model of `r reduced.r.adjusted` with the model we arrived out built bottom-up from initial predictors and it's adjusted $R^2$ of `r lm5.r.adjusted` indicates that the additional explained variation is minimal.  Seeking a simpler model, we feel confident that our model will perform accurately after residual error and examination of the diagnostic plots.


# Analysis

## Initial Model

```{r, echo=FALSE, out.height="200px", out.width="250px", fig.align="center"}

# Initial Model
lm.price <- lm(formula = price ~ sqft_living + grade + view + yr_built + has_basement, 
            data = df)
par(mfrow = c(1,3))
plot(lm.price,c(1,2,4))
```


```{r, echo=FALSE, out.height="150px", fig.align="center"}
boxCox(lm.price, main="Box-Cox Plot of model")
```

```{r, echo=FALSE, out.height="150px", fig.align="center"}
par(mfrow = c(1,3))
lm.price <- lm(formula = log(price) ~ sqft_living + grade + view + yr_built + has_basement, 
            data = df)
plot(lm.price,c(1,2,4))
```


```{r, echo=FALSE, out.height="150px", fig.align="center"}
p <- ggplot(df, aes(x=sqft_living)) + geom_density()
q <- ggplot(df, aes(x=log(sqft_living))) + geom_density()
r <- ggplot(df, aes(x=price)) + geom_density()
s <- ggplot(df, aes(x=log(price))) + geom_density()
grid.arrange(grobs=list(p, q,
                        r, s),
             ncol=2,
             top="Transformations on Skewed Distributions") 
```


```{r, echo=FALSE, results='asis'}
# VIF Table
stargazer(vif(lm.price), title="VIF Values for Price Model", header=FALSE)
```

# Results and Conclusions



\newpage

# Appendix: All Code for This Report

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```